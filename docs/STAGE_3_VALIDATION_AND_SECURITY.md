# ุงููุฑุญูุฉ 3: ุงููููุฏ ูุงูุฌูุฏุฉ - ุงูุชูุซูู

## โ ูุง ุชู ุฅูุฌุงุฒู

### 1. ูููุฏ ุงูุชุญูู (Validation Constraints)

#### ูููุฏ ูุงุนุฏุฉ ุงูุจูุงูุงุช (Database Constraints)
ุชู ุฅุถุงูุฉ ูููุฏ ุนูู ูุณุชูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุถูุงู ุณูุงูุฉ ุงูุจูุงูุงุช:

- **ุงููููุงุช ุงูููุฌุจุฉ**: ุฌููุน ุงููููุงุช ูุฌุจ ุฃู ุชููู >= 0
- **ุงูุฃุณุนุงุฑ ุงูููุฌุจุฉ**: ุฌููุน ุงูุฃุณุนุงุฑ ูุงูุชูุงููู ูุฌุจ ุฃู ุชููู >= 0
- **ูุทุงู ุงูุฎุตู**: ุงูุฎุตููุงุช ูุญุตูุฑุฉ ุจูู 0-100%
- **ูุทุงู ุงูุถุฑุงุฆุจ**: ูุณุจ ุงูุถุฑุงุฆุจ ูุญุตูุฑุฉ ุจูู 0-100%
- **ุชุงุฑูุฎ ุงูุชูุงุก ุงูุตูุงุญูุฉ**: ูุง ูููู ุฃู ูููู ูู ุงููุงุถู (ุนุจุฑ Trigger)
- **ุงููููุฏ ุงูููููุฉ**: ูุฌุจ ุฃู ูููู ุงููุฏูู = ุงูุฏุงุฆู
- **ุณุทูุฑ ุงููููุฏ**: ูุง ูููู ุฃู ูููู ุงููุจูุบ ูู ุงูุฌุงูุจูู ูุนุงู

#### ูุฎุทุทุงุช ุงูุชุญูู ูู ุงููุฏุฎูุงุช (Zod Schemas)
ุชู ุฅูุดุงุก ููู `src/lib/validationSchemas.ts` ูุญุชูู ุนูู:

- `productSchema`: ุงูุชุญูู ูู ุจูุงูุงุช ุงูููุชุฌุงุช
- `saleItemSchema`: ุงูุชุญูู ูู ุนูุงุตุฑ ุงููุจูุนุงุช
- `saleSchema`: ุงูุชุญูู ูู ุงููุจูุนุงุช
- `purchaseOrderSchema`: ุงูุชุญูู ูู ุฃูุงูุฑ ุงูุดุฑุงุก
- `poItemSchema`: ุงูุชุญูู ูู ุนูุงุตุฑ ุฃูุงูุฑ ุงูุดุฑุงุก
- `purchaseInvoiceSchema`: ุงูุชุญูู ูู ููุงุชูุฑ ุงูุดุฑุงุก
- `productBatchSchema`: ุงูุชุญูู ูู ุฏูุนุงุช ุงูููุชุฌุงุช
- `journalEntrySchema`: ุงูุชุญูู ูู ุงููููุฏ ุงูููููุฉ
- `journalEntryLineSchema`: ุงูุชุญูู ูู ุณุทูุฑ ุงููููุฏ
- `customerSchema`: ุงูุชุญูู ูู ุจูุงูุงุช ุงูุนููุงุก
- `supplierSchema`: ุงูุชุญูู ูู ุจูุงูุงุช ุงูููุฑุฏูู
- `taxSchema`: ุงูุชุญูู ูู ุจูุงูุงุช ุงูุถุฑุงุฆุจ
- `reorderRuleSchema`: ุงูุชุญูู ูู ููุงุนุฏ ุฅุนุงุฏุฉ ุงูุทูุจ
- `itemPriceSchema`: ุงูุชุญูู ูู ุฃุณุนุงุฑ ุงูููุชุฌุงุช

**ุงุณุชุฎุฏุงู:**
```typescript
import { validateInput, productSchema } from "@/lib/validationSchemas";

const result = validateInput(productSchema, productData);
if (!result.success) {
  console.error(result.errors);
} else {
  // ุงูุจูุงูุงุช ุตุญูุญุฉ
  console.log(result.data);
}
```

### 2. ููุงุฑุณ ุงูุฃุฏุงุก (Performance Indexes)

ุชู ุฅุถุงูุฉ ููุงุฑุณ ุนูู ุงูุฃุนูุฏุฉ ูุซูุฑุฉ ุงูุจุญุซ ูุชุณุฑูุน ุงูุงุณุชุนูุงูุงุช:

#### ููุงุฑุณ ุงูููุชุฌุงุช
- `idx_products_category`: ุงูุจุญุซ ุจุงูุชุตููู
- `idx_products_status`: ุงูุจุญุซ ุจุงูุญุงูุฉ
- `idx_products_barcode`: ุงูุจุญุซ ุจุงูุจุงุฑููุฏ
- `idx_products_sku`: ุงูุจุญุซ ุจุฑูุฒ ุงูููุชุฌ
- `idx_products_created_at`: ุงูุชุฑุชูุจ ุจุชุงุฑูุฎ ุงูุฅูุดุงุก

#### ููุงุฑุณ ุงููุจูุนุงุช
- `idx_sales_customer`: ุงูุจุญุซ ุจุงูุนููู
- `idx_sales_warehouse`: ุงูุจุญุซ ุจุงููุณุชูุฏุน
- `idx_sales_date`: ุงูุจุญุซ ุจุงูุชุงุฑูุฎ
- `idx_sales_created_at`: ุงูุชุฑุชูุจ ุจุชุงุฑูุฎ ุงูุฅูุดุงุก
- `idx_sales_status`: ุงูุจุญุซ ุจุญุงูุฉ ุงูุฏูุน
- `idx_sales_session`: ุงูุจุญุซ ุจุฌูุณุฉ POS

#### ููุงุฑุณ ุฃูุงูุฑ ุงูุดุฑุงุก
- `idx_po_supplier`: ุงูุจุญุซ ุจุงูููุฑุฏ
- `idx_po_warehouse`: ุงูุจุญุซ ุจุงููุณุชูุฏุน
- `idx_po_status`: ุงูุจุญุซ ุจุงูุญุงูุฉ
- `idx_po_created_at`: ุงูุชุฑุชูุจ ุจุชุงุฑูุฎ ุงูุฅูุดุงุก
- `idx_po_expected_date`: ุงูุจุญุซ ุจุชุงุฑูุฎ ุงูุงุณุชูุงู ุงููุชููุน

#### ููุงุฑุณ ุงููุญุงุณุจุฉ
- `idx_journal_entries_date`: ุงูุจุญุซ ุจุงูุชุงุฑูุฎ
- `idx_journal_entries_status`: ุงูุจุญุซ ุจุงูุญุงูุฉ
- `idx_journal_lines_account`: ุงูุจุญุซ ุจุงูุญุณุงุจ
- `idx_journal_lines_entry`: ุฑุจุท ุงูุณุทูุฑ ุจุงูููุฏ

#### ููุงุฑุณ ุฃุฎุฑู
- ููุงุฑุณ ุนูู `goods_receipts`, `purchase_invoices`, `product_batches`
- ููุงุฑุณ ุนูู `payments`, `customers`, `suppliers`

### 3. ุณูุงุณุงุช RLS (Row Level Security)

#### ููุฎุต ุงูุตูุงุญูุงุช

| ุงูุฏูุฑ              | ุงููุจูุนุงุช | ุงูุดุฑุงุก | ุงููุฎุฒูู | ุงููุญุงุณุจุฉ | ุงูุฅุนุฏุงุฏุงุช |
|-------------------|---------|--------|---------|---------|----------|
| admin             | โโโ     | โโโ    | โโโ     | โโโ     | โโโ      |
| pharmacist        | โโ      | ูุฑุงุกุฉ   | ูุฑุงุกุฉ    | ูุฑุงุกุฉ    | ูุฑุงุกุฉ     |
| cashier           | โ       | -      | ูุฑุงุกุฉ    | -       | -        |
| inventory_manager | -       | โโ     | โโโ     | -       | -        |

**ุงูุฑููุฒ:**
- โโโ = ูู ุงูุตูุงุญูุงุช (ุฅูุดุงุกุ ุชุนุฏููุ ุญุฐูุ ุชุฑุญูู)
- โโ  = ุฅูุดุงุก ูุชุนุฏูู
- โ   = ุฅูุดุงุก ููุท
- ูุฑุงุกุฉ = ุนุฑุถ ููุท
- \-   = ูุง ุตูุงุญูุฉ

#### ุณูุงุณุงุช ุญูุงูุฉ ุงููุณุชูุฏุงุช ุงููุฑุญููุฉ

ุชู ุฅุถุงูุฉ ุณูุงุณุงุช ูููุน ุชุนุฏูู ุฃู ุญุฐู ุงููุณุชูุฏุงุช ุงููุฑุญููุฉ:

- **ุฃูุงูุฑ ุงูุดุฑุงุก**: ูุง ูููู ุชุนุฏูู ุฃู ุญุฐู ุฃูุฑ ุดุฑุงุก ูุฑุญูู
- **ููุงุชูุฑ ุงูุดุฑุงุก**: ูุง ูููู ุชุนุฏูู ุฃู ุญุฐู ูุงุชูุฑุฉ ุดุฑุงุก ูุฑุญููุฉ
- **ุงุณุชูุงู ุงูุจุถุงุฆุน (GRN)**: ูุง ูููู ุชุนุฏูู ุฃู ุญุฐู GRN ูุฑุญูู
- **ุงููููุฏ ุงูููููุฉ**: ูุง ูููู ุชุนุฏูู ุฃู ุญุฐู ููุฏ ูุฑุญูู

#### ุณูุงุณุงุช ุงูุญุฐู

- **ุงููุฏูุฑ ููุท** ููููู ุญุฐู ุงููุณุชูุฏุงุช
- **ุงููุณุชูุฏุงุช ุบูุฑ ุงููุฑุญููุฉ ููุท** (draft) ูููู ุญุฐููุง

#### ูุฑุงุฌุนุฉ ุงูุฃุฏูุงุฑ

##### Admin (ุงููุฏูุฑ)
- ูู ุงูุตูุงุญูุงุช ุนูู ุฌููุน ุงูุฌุฏุงูู
- ุฅูุดุงุก ูุชุนุฏูู ูุญุฐู ูุชุฑุญูู ุฌููุน ุงููุณุชูุฏุงุช
- ุงููุตูู ุงููุงูู ูุฅุนุฏุงุฏุงุช ุงููุธุงู

##### Pharmacist (ุงูุตูุฏูู)
- ุฅุฏุงุฑุฉ ุงููุจูุนุงุช (ุฅูุดุงุก ูุชุนุฏูู)
- ุฅุฏุงุฑุฉ ุงูุนููุงุก
- ุนุฑุถ ุงููุฎุฒูู ูุงูุชูุงุฑูุฑ
- ุนุฑุถ ุงููุญุงุณุจุฉ (ูุฑุงุกุฉ ููุท)
- **ูุง ููููู**: ุชุฑุญูู ููุงุชูุฑ ุงูุดุฑุงุกุ ุชุนุฏูู ุงูุฅุนุฏุงุฏุงุช

##### Cashier (ุงููุงุดูุฑ)
- ุฅูุดุงุก ูุจูุนุงุช ููุท (ููุทุฉ ุงูุจูุน)
- ุนุฑุถ ุงูููุชุฌุงุช ูุงูุฃุณุนุงุฑ
- ุนุฑุถ ุงูุนููุงุก
- **ูุง ููููู**: ุชุนุฏูู ุฃู ุญุฐู ุงููุจูุนุงุชุ ุงููุตูู ูููุญุงุณุจุฉ

##### Inventory Manager (ูุฏูุฑ ุงููุฎุฒูู)
- ุฅุฏุงุฑุฉ ุงููุฎุฒูู (ุฅูุดุงุก ูุชุนุฏูู)
- ุฅุฏุงุฑุฉ ุงููุดุชุฑูุงุช (ุฃูุงูุฑ ุงูุดุฑุงุกุ ุงุณุชูุงู ุงูุจุถุงุฆุน)
- ุฅุฏุงุฑุฉ ุงูููุฑุฏูู
- **ูุง ููููู**: ุงููุตูู ูููุญุงุณุจุฉุ ุฅุนุฏุงุฏุงุช ุงููุธุงู

## ๐งช ุงุฎุชุจุงุฑุงุช ุงูุชุญูู

### 1. ุงุฎุชุจุงุฑ ุงููููุฏ

```sql
-- ูุญุงููุฉ ุฅุฏุฎุงู ูููุฉ ุณุงูุจุฉ (ูุฌุจ ุฃู ุชูุดู)
INSERT INTO products (name, quantity, price, cost_price) 
VALUES ('ููุชุฌ ุชุฌุฑูุจู', -10, 100, 80);
-- โ ERROR: new row violates check constraint "check_products_quantity_positive"

-- ูุญุงููุฉ ุฅุฏุฎุงู ุฎุตู ุฃูุซุฑ ูู 100% (ูุฌุจ ุฃู ุชูุดู)
INSERT INTO sale_items (sale_id, product_id, quantity, unit_price, discount, total)
VALUES ('uuid', 'uuid', 1, 100, 150, 50);
-- โ ERROR: new row violates check constraint "check_sale_items_discount_range"

-- ูุญุงููุฉ ุฅุฏุฎุงู ุชุงุฑูุฎ ุงูุชูุงุก ุตูุงุญูุฉ ูู ุงููุงุถู (ูุฌุจ ุฃู ุชูุดู)
INSERT INTO product_batches (product_id, batch_number, quantity, cost_price, expiry_date)
VALUES ('uuid', 'BATCH001', 100, 50, '2020-01-01');
-- โ ERROR: ุชุงุฑูุฎ ุงูุชูุงุก ุงูุตูุงุญูุฉ ูุง ูููู ุฃู ูููู ูู ุงููุงุถู
```

### 2. ุงุฎุชุจุงุฑ ุงูุฃุฏุงุก

```sql
-- ุงูุจุญุซ ุนู ููุชุฌ ุจุงูุจุงุฑููุฏ (ูุฌุจ ุฃู ูููู ุณุฑูุนุงู)
EXPLAIN ANALYZE
SELECT * FROM products WHERE barcode = '1234567890';

-- ุงูุจุญุซ ุนู ูุจูุนุงุช ุนููู ูุนูู (ูุฌุจ ุฃู ูููู ุณุฑูุนุงู)
EXPLAIN ANALYZE
SELECT * FROM sales WHERE customer_id = 'uuid' ORDER BY created_at DESC;

-- ุงูุจุญุซ ุนู ุฃูุงูุฑ ุดุฑุงุก ุจุญุงูุฉ ูุนููุฉ (ูุฌุจ ุฃู ูููู ุณุฑูุนุงู)
EXPLAIN ANALYZE
SELECT * FROM purchase_orders WHERE status = 'pending';
```

### 3. ุงุฎุชุจุงุฑ RLS

```sql
-- ุชุณุฌูู ุฏุฎูู ูู cashier
-- ูุญุงููุฉ ุงููุตูู ูููุญุงุณุจุฉ (ูุฌุจ ุฃู ุชูุดู)
SELECT * FROM gl_accounts;
-- โ No rows returned (RLS blocks access)

-- ูุญุงููุฉ ุชุนุฏูู ุฅุนุฏุงุฏุงุช ุงููุธุงู (ูุฌุจ ุฃู ุชูุดู)
UPDATE system_settings SET setting_value = '{}' WHERE setting_key = 'default_currency';
-- โ UPDATE 0 (RLS blocks access)

-- ุชุณุฌูู ุฏุฎูู ูู inventory_manager
-- ูุญุงููุฉ ุงููุตูู ูููุญุงุณุจุฉ (ูุฌุจ ุฃู ุชูุดู)
SELECT * FROM journal_entries;
-- โ No rows returned (RLS blocks access)

-- ูุญุงููุฉ ุฅูุดุงุก ุฃูุฑ ุดุฑุงุก (ูุฌุจ ุฃู ุชูุฌุญ)
INSERT INTO purchase_orders (po_number, supplier_id, warehouse_id, status)
VALUES ('PO-001', 'uuid', 'uuid', 'draft');
-- โ Success

-- ุชุณุฌูู ุฏุฎูู ูู admin
-- ูุญุงููุฉ ุชุนุฏูู ูุณุชูุฏ ูุฑุญูู (ูุฌุจ ุฃู ุชูุดู)
UPDATE purchase_orders SET total_amount = 5000 WHERE status = 'posted';
-- โ UPDATE 0 (Policy prevents editing posted documents)
```

## ๐ ูุงุฆูุฉ ุงูุชุญูู ุงูููุงุฆูุฉ

- โ ูููุฏ ุงูุชุญูู ุนูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ูุฎุทุทุงุช ุงูุชุญูู ูู ุงููุฏุฎูุงุช (Zod)
- โ ููุงุฑุณ ุงูุฃุฏุงุก ุนูู ุงูุฃุนูุฏุฉ ุงููููุฉ
- โ ุณูุงุณุงุช RLS ููุฃุฏูุงุฑ ุงููุฎุชููุฉ
- โ ุญูุงูุฉ ุงููุณุชูุฏุงุช ุงููุฑุญููุฉ ูู ุงูุชุนุฏูู
- โ ูููุฏ ุงูุญุฐู (ุงููุฏูุฑ ููุท ูููุณุชูุฏุงุช ุบูุฑ ุงููุฑุญููุฉ)
- โ Trigger ููุชุญูู ูู ุชุงุฑูุฎ ุงูุชูุงุก ุงูุตูุงุญูุฉ

## ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ

1. ุฏูุฌ ูุฎุทุทุงุช Zod ูู ูุงุฌูุงุช ุงููุณุชุฎุฏู
2. ุฅุถุงูุฉ ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ ูู ุงููุงุฌูุฉ
3. ุงุฎุชุจุงุฑ ุงูุฃุฏุงุก ูุน ุจูุงูุงุช ุญููููุฉ
4. ูุฑุงุฌุนุฉ ุงูุณูุงุณุงุช ูุน ูุฑูู ุงูุฃูุงู
5. ุชูุซูู ุงูุตูุงุญูุงุช ูููุณุชุฎุฏููู ุงูููุงุฆููู
