# دليل استخدام نظام العملات المتعددة

## نظرة عامة

نظام العملات المتعددة يدعم إجراء المعاملات بعملات مختلفة مع الحفاظ على **الريال اليمني (YER)** كعملة أساسية لجميع التقارير والقيود المحاسبية.

## العملة الأساسية

- **YER (الريال اليمني)** هي العملة الأساسية للنظام
- لا يمكن حذف العملة الأساسية
- جميع التقارير المالية تُعرض بالعملة الأساسية
- القيود المحاسبية تُسجل بكلا العملتين (المعاملة والأساسية)

## إعداد أسعار الصرف

### الوصول لصفحة أسعار الصرف
```
الإعدادات → أسعار الصرف
/settings/exchange-rates
```

### إضافة سعر صرف جديد

1. انتقل إلى صفحة أسعار الصرف
2. اضغط على "إضافة سعر صرف"
3. اختر العملة الأجنبية (مثل: SAR, USD)
4. أدخل سعر الصرف (مثال: 1 SAR = 66.50 YER)
5. حدد تاريخ السريان
6. اضغط حفظ

### قواعد أسعار الصرف

- **تاريخ السريان**: النظام يستخدم آخر سعر صرف قبل أو في تاريخ المعاملة
- **السعر العكسي**: إذا لم يوجد سعر مباشر، النظام يحسب السعر العكسي تلقائياً
- **إذا لم يوجد سعر**: النظام يمنع ترحيل المعاملة ويعرض رسالة خطأ

## استخدام العملات في الفواتير

### فواتير المبيعات

1. عند إنشاء فاتورة جديدة، اختر العملة من القائمة
2. النظام يعرض سعر الصرف تلقائياً
3. المبالغ تظهر بكلا العملتين:
   - **المبلغ بعملة المعاملة (FC)**: المبلغ الفعلي بالعملة المختارة
   - **المبلغ بالعملة الأساسية (BC)**: المعادل بالريال اليمني

### مثال عملي

```
فاتورة مبيعات:
- العملة: SAR (ريال سعودي)
- المبلغ: 1,000 SAR
- سعر الصرف: 66.50
- المعادل بالريال اليمني: 66,500 YER
```

## الصناديق النقدية (الخزائن)

### إعداد صندوق لكل عملة

كل صندوق نقدي مرتبط بعملة واحدة فقط:
- صندوق YER للريال اليمني
- صندوق SAR للريال السعودي
- صندوق USD للدولار الأمريكي

### قواعد الصناديق

- المعاملات النقدية تُوجه للصندوق المناسب حسب العملة
- لا يمكن إيداع عملة في صندوق عملة مختلفة
- التحويلات بين صناديق عملات مختلفة تنشئ قيود فروق عملة

## القيود المحاسبية

### البنية المزدوجة

كل بند في القيد المحاسبي يحتوي على:
- `debit_fc` / `credit_fc`: المدين/الدائن بعملة المعاملة
- `debit_bc` / `credit_bc`: المدين/الدائن بالعملة الأساسية (YER)
- `currency_code`: رمز عملة المعاملة
- `exchange_rate`: سعر الصرف المستخدم

### مثال قيد محاسبي

```
فاتورة مبيعات بـ 1,000 SAR (سعر الصرف: 66.50)

مدين: العملاء
  - debit_fc: 1,000 SAR
  - debit_bc: 66,500 YER

دائن: إيرادات المبيعات
  - credit_fc: 1,000 SAR  
  - credit_bc: 66,500 YER
```

## أرباح وخسائر الصرف

### الحسابات المستخدمة

| الحساب | الرمز | الوصف |
|--------|-------|-------|
| أرباح فروق العملة المحققة | 4400 | عند تسوية المعاملات بسعر أفضل |
| خسائر فروق العملة المحققة | 5400 | عند تسوية المعاملات بسعر أسوأ |
| أرباح فروق العملة غير المحققة | 4401 | تقييم نهاية الفترة (مستقبلي) |
| خسائر فروق العملة غير المحققة | 5401 | تقييم نهاية الفترة (مستقبلي) |

### متى تنشأ فروق الصرف المحققة؟

عندما يختلف سعر الصرف عند السداد عن سعر الصرف عند إنشاء الفاتورة:

```
مثال:
- فاتورة: 1,000 SAR بسعر 66.50 = 66,500 YER
- السداد: 1,000 SAR بسعر 67.00 = 67,000 YER
- ربح صرف محقق: 500 YER
```

## تكلفة المخزون (FIFO)

### القاعدة الأساسية

جميع طبقات التكلفة (FIFO layers) تُخزن بالعملة الأساسية (YER) فقط.

### مثال شراء بعملة أجنبية

```
شراء 100 وحدة بـ 10 SAR/وحدة (سعر الصرف: 66.50)

التكلفة المخزنة: 10 × 66.50 = 665 YER/وحدة
```

## التقارير المالية

جميع التقارير تُعرض بالعملة الأساسية (YER):
- ميزان المراجعة
- قائمة الدخل
- الميزانية العمومية
- تقرير التدفقات النقدية

## الأسئلة الشائعة

### س: ماذا يحدث إذا لم أختر عملة في الفاتورة؟
**ج:** النظام يستخدم العملة الأساسية (YER) تلقائياً مع سعر صرف = 1.

### س: هل يمكن تغيير عملة فاتورة مرحّلة؟
**ج:** لا، لا يمكن تغيير العملة بعد الترحيل.

### س: كيف أضيف سعر صرف لتاريخ سابق؟
**ج:** أدخل سعر الصرف مع تاريخ السريان المطلوب. النظام يدعم الأسعار التاريخية.

### س: ماذا لو نسيت إدخال سعر الصرف؟
**ج:** النظام سيمنع ترحيل أي معاملة بدون سعر صرف ويعرض رسالة خطأ واضحة.

---

## الملفات التقنية المرتبطة

- `src/lib/currency.ts` - دوال العملات وأسعار الصرف
- `src/pages/ExchangeRates.tsx` - صفحة إدارة أسعار الصرف
- `src/components/CurrencySelect.tsx` - مكون اختيار العملة
